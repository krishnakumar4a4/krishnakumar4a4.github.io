<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     In-Memory Caching: Curb Tail Latency with Pelikan | 
    Krishna Kumar T
  
</title><meta name="description" content="In-Memory Caching: Curb Tail Latency with Pelikan"><meta name="author" content="Krishna Kumar Thokala">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">


    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism-okaidia.min.css">
    



    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://krishnakumar4a4.github.io/post/in-memory-caching-curb-tail-latency-with-pelikan/"><meta property="og:title" content="In-Memory Caching: Curb Tail Latency with Pelikan" />
<meta property="og:description" content="In-Memory Caching: Curb Tail Latency with Pelikan" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://krishnakumar4a4.github.io/post/in-memory-caching-curb-tail-latency-with-pelikan/" />
<meta property="article:published_time" content="2016-12-24T09:43:12&#43;05:30"/>
<meta property="article:modified_time" content="2016-12-24T09:43:12&#43;05:30"/>


<meta itemprop="name" content="In-Memory Caching: Curb Tail Latency with Pelikan">
<meta itemprop="description" content="In-Memory Caching: Curb Tail Latency with Pelikan">


<meta itemprop="datePublished" content="2016-12-24T09:43:12&#43;05:30" />
<meta itemprop="dateModified" content="2016-12-24T09:43:12&#43;05:30" />
<meta itemprop="wordCount" content="733">



<meta itemprop="keywords" content="cache," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In-Memory Caching: Curb Tail Latency with Pelikan"/>
<meta name="twitter:description" content="In-Memory Caching: Curb Tail Latency with Pelikan"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://krishnakumar4a4.github.io">Krishna Kumar T</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/about/">About</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/project-updates/">Project Updates</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/github-projects/">Github Projects</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/post/">Posts</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/tweets/">Tweets</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/linkedin-posts/">LinkedIn Posts</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/team/">Team</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/tags/">Tags</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">December 24, 2016</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>733 words</span>
                            <span><i class="fas fa-clock mr-2"></i>4 mins read</span>
                        </div>

                        <h1>In-Memory Caching: Curb Tail Latency with Pelikan</h1>

                        <ul class="authors list-inline"><li class="list-inline-item mr-3">
                    <div class="media author"><a href="/authors/krishna-kumar-thokala/" class="mr-3">
                                    <picture>
                                        <source srcset="/authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_64x0_resize_box_2.png 1x, /authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_128x0_resize_q100_box_2.png 2x, /authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_192x0_resize_q100_box_2.png 3x">
                                        <img src="/authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_64x0_resize_box_2.png" class="rounded-circle" alt="Krishna Kumar Thokala">
                                    </picture>
                                </a><div class="media-body">
                            <h5 class="name my-0"><a href="/authors/krishna-kumar-thokala/" class="small">Krishna Kumar Thokala</a>
                            </h5><p class="social small text-muted">
                                    <a href="https://twitter.com/@krishnakumart36">@KrishnaKumarT36</a>
                                </p></div>
                    </div>
                </li></ul>
                    </div>
                </div><div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            

<blockquote>
<p>Tail latency: When you have a bunch of servers trying to serve a request in parallel, One of the servers might take more time than others which affects the overall response time. In other words, Latency of a tail server(worst performing) is affecting the whole response time.</p>
</blockquote>

<p>When thinking about scale,distribution and speed. Caching is one of the important thing that stumbles you. Understanding it, mean a lot while you wanted to improve or implement them in other programming languages. That drove me here.</p>

<h3 id="cache-performance">Cache Performance:</h3>

<p>Ideally, We put the cache alongside the database to absorb the load.</p>

<p>If cache is effective with 95% hit-rate and if suddenly it fell down to 90%, the database hit rate would almost double. What if the cache hit-rate keeps on diminishing and most of the databases are not designed handle this kind of surge and hence the whole application performance would go haywire.</p>

<p>Good Cache performance = Predictable Tail Latency</p>

<h3 id="chasing-the-ghosts">Chasing the Ghosts:</h3>

<p>Caching in Datacenter: Machines are connected with very high speed network,Since the cost of connection is low,there would be lot of long-lived connections.</p>

<p>Cache: Bird’s view:
&gt;Event-driven server: High speed and performant event driven server
&gt;Protocol: Memcache,redis
&gt;data Storage: Probably an In-Memory storage</p>

<p><strong><em>Problem</em></strong>: Some Cache servers are using really high bandwidth, yet the request rate is very low.</p>

<p><strong><em>Digged in</em></strong>: Lot of new connections are being created but very less activities on each one of them. Creating a TCP connection is at least 4+ SysCalls whereas request at max using 3 SysCalls and hence the culprit found was Connection storm.</p>

<p><strong><em>Problem</em></strong>: Random Cache hiccups, always at the top of the hour.</p>

<p><strong><em>Digged in</em></strong>: While logging, buffer fills up waiting for the disk and during which if some cronjob kicks in which is continuously hanging up with disk by preventing the actual buffer filled by logger to write. This is a hiccup.</p>

<p><strong><em>Solution</em></strong>: Never do blocking IO for such logging mechanisms. A link <a href="http://faculty.salina.k-state.edu/tim/ossg/Device/blocking.html">http://faculty.salina.k-state.edu/tim/ossg/Device/blocking.html</a></p>

<p><strong><em>Problem</em></strong>: Seeing several blips after each cache reboot. They never happen indefinitely and calms down.</p>

<p><strong><em>Digged in</em></strong>: Hash table expansion happens when the key to hash entry ratio goes over a threshold i.e basically hash memory allocation doubles up. During this time, locking happens as the entries has to move over.</p>

<p><strong><em>Solution</em></strong>: As this can’t be eliminated, clearing up cache logs might give some fresh breath to these operations.
<strong><em>Problem</em></strong>: Hosts with long running caches which suddenly gives oom in the kernel log and kills the cache.</p>

<p><strong><em>Digged in</em></strong>: Fragmentation, when kernel requires contiguous memory and another application trying to get the contiguous memory will end up killing the cache process for getting hold of contiguous memory.</p>

<p><strong><em>Problem</em></strong>: Redis instances are killed by scheduler.</p>

<p><strong><em>Digged in</em></strong>: How much memory the kernel thinks you are using and how much memory you think you are using. These numbers may increase and this fragmentation is completely dependent on the type of load/action that is being run at the moment and it is unpredictable.</p>

<h3 id="the-mitigation-plan-pelikan-cache">The Mitigation Plan — Pelikan Cache:</h3>

<p>Borrowed concept from networking, Separation of Data Plane and Control plane.</p>

<p><strong><em>Data Plane</em></strong>: Only handles packets and handover it to Control plane.
<strong><em>Control plane</em></strong>: Does the networking like implementing BGP or stuff like that.</p>

<p>Put operations of different nature on different threads.
- Tasks which are necessary but not performance critical are placed on one thread(Control plane) like connection listening, stats aggregation, stats exporting, log dump etc.
- All the request/response processing is placed on data plane thread which is faster.
- Connects are also handled by separate data plane thread which is also faster.</p>

<p>Lockless Operations:
- Make stats update lockless with atomic instructions which does locking/serialization at hardware level and hence preventing software overhead.
- Make logging waitless using ring/cyclic buffer and uses atomic operations.
- Make connection hand-off lockless by using ring array.</p>

<p>Memory:
- Reduce internal and external fragmentation.
- Never want to do any swapping as the performance will be gone when wrote to disk.
- Avoid external fragmentation, cap all memory resources.
- Reuse connection buffers and prevent calling malloc functions and if we are able to cap all the resources means we can do preallocation as well which gives lot of runtime performance.</p>

<h3 id="future-scope-of-pelikan">Future scope of Pelikan:</h3>

<h5 id="memcached">Memcached:</h5>

<ul>
<li>Multiple worker threads</li>

<li><p>Binary protocol + SASL</p>

<h4 id="redis">REDIS:</h4></li>

<li><p>Rich set of data structures</p></li>

<li><p>Master-slave replication</p></li>

<li><p>redis-cluster</p></li>

<li><p>modules</p></li>

<li><p>tools</p></li>
</ul>

<p>The best cache is ALWAYS FAST.</p>

<h3 id="references">References</h3>

<p><a href="https://twitter.github.io/pelikan/">https://twitter.github.io/pelikan/</a>
<a href="https://qconsf.com/sf2016/sf2016/presentation/pelikan-quest-low-latencies.html">https://qconsf.com/sf2016/sf2016/presentation/pelikan-quest-low-latencies.html</a>
<a href="https://www.infoq.com/interviews/yue-twitter-pelikan-cache/">https://www.infoq.com/interviews/yue-twitter-pelikan-cache/</a></p>

                        </div><div class="tags my-3"><a class="badge badge-pill badge-light border mr-2" href="/tags/cache">
                                    <i class="fas fa-tag mr-2"></i>cache
                                </a></div><ul class="share nav my-3 justify-content-end">
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fin-memory-caching-curb-tail-latency-with-pelikan%2f&text=In-Memory%20Caching%3a%20Curb%20Tail%20Latency%20with%20Pelikan">
              <i class="fa-fw fab fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fin-memory-caching-curb-tail-latency-with-pelikan%2f&title=In-Memory%20Caching%3a%20Curb%20Tail%20Latency%20with%20Pelikan">
                <i class="fa-fw fab fa-linkedin-in"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fin-memory-caching-curb-tail-latency-with-pelikan%2f&t=In-Memory%20Caching%3a%20Curb%20Tail%20Latency%20with%20Pelikan">
                <i class="fa-fw fab fa-facebook-f"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://reddit.com/submit?url=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fin-memory-caching-curb-tail-latency-with-pelikan%2f&title=In-Memory%20Caching%3a%20Curb%20Tail%20Latency%20with%20Pelikan">
                <i class="fa-fw fab fa-reddit-alien"></i>
            </a>
        </li>
    </nav>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div><div class="row justify-content-center my-3">
                    <div class="col-lg-8">
                        <div id="commento"></div>
                        <script src="https://commento.io"></script>
                    </div>
                </div></article>
        </div>
    </div>

    
    <footer>
        <script src="https://giscus.app/client.js"
    data-repo="krishnakumar4a4/krishnakumar4a4.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMDA3OTMxMTU="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOBgH7G84CUoxF"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light_high_contrast"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
  <br/>
  <div style="border: 2px solid black; 
  border-radius: 5px; padding: 2px 5px 0px 5px;
  width: fit-content; 
  margin-left: auto; margin-right: 0;">
    <p style="text-align: right">
    <span style="font-family: sans-serif;font-size: 14px;"> Alternatively, you can  </span>
    <button style="background:#055d20;
    font-size: 14px;display: inline-block;
    border-bottom-color: #013d14;
    font-family: sans-serif;
    font-weight: 400;
    color:white;
    border-radius: 5px" onclick="window.location.href = 'https://github.com/krishnakumar4a4/krishnakumar4a4.github.io/discussions/categories/blog-comments';">
    Comment directly on Github Discussion
    </button>
    <br/>
    <span style="font-family: sans-serif;font-size: 14px;"><span>#️⃣</span>
    <span style="color: #055d20">In-Memory Caching: Curb Tail Latency with Pelikan</span>
    </span>
    </p>
  </div>
    </footer>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://krishnakumar4a4.github.io/index.xml" rel="alternate" type="application/rss+xml" class="icons d-block">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a></li><li class="list-inline-item">
                        <a href="mailto:krishna.thokala2010@gmail.com" class="icons d-block">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li><li class="list-inline-item">
                            <a href="https://github.com/krishnakumar4a4" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://keybase.io/krishnakumart" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-keybase fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.linkedin.com/in/krishnakumarthokala/" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://fsmi.social/krishnakumart" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://krishnakumart.medium.com/" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://reddit.com/u/krishnakumart" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-reddit fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://twitter.com/KrishnaKumarT36" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; Krishna Kumar T 2023
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    



<script>
    window.Prism = window.Prism || {};
    window.Prism.manual = true;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>






    
</body>
</html>
