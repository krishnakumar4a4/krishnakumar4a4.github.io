<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Million event Erlang “like” engine | 
    Krishna Kumar T
  
</title><meta name="description" content="Million event Erlang “like” engine"><meta name="author" content="Krishna Kumar Thokala">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">


    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism-okaidia.min.css">
    



    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://krishnakumar4a4.github.io/post/million-event-erlang-engine/"><meta property="og:title" content="Million event Erlang “like” engine" />
<meta property="og:description" content="Million event Erlang “like” engine" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://krishnakumar4a4.github.io/post/million-event-erlang-engine/" />
<meta property="article:published_time" content="2016-12-07T09:43:12&#43;05:30"/>
<meta property="article:modified_time" content="2016-12-07T09:43:12&#43;05:30"/><meta property="og:see_also" content="https://krishnakumar4a4.github.io/post/speakup-announcement/" /><meta property="og:see_also" content="https://krishnakumar4a4.github.io/post/comparision-erlang-and-rust/" /><meta property="og:see_also" content="https://krishnakumar4a4.github.io/post/simplifying-erlang-beam/" /><meta property="og:see_also" content="https://krishnakumar4a4.github.io/post/react-redux-erlang-analogy/" /><meta property="og:see_also" content="https://krishnakumar4a4.github.io/post/be-on-your-best-erlang-behavior/" /><meta property="og:see_also" content="https://krishnakumar4a4.github.io/post/know-why-you-may-choose-erlang/" />


<meta itemprop="name" content="Million event Erlang “like” engine">
<meta itemprop="description" content="Million event Erlang “like” engine">


<meta itemprop="datePublished" content="2016-12-07T09:43:12&#43;05:30" />
<meta itemprop="dateModified" content="2016-12-07T09:43:12&#43;05:30" />
<meta itemprop="wordCount" content="981">



<meta itemprop="keywords" content="erlang," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Million event Erlang “like” engine"/>
<meta name="twitter:description" content="Million event Erlang “like” engine"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://krishnakumar4a4.github.io">Krishna Kumar T</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/about/">About</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/project-updates/">Project Updates</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/github-projects/">Github Projects</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/post/">Posts</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/tweets/">Tweets</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/linkedin-posts/">LinkedIn Posts</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/team/">Team</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/tags/">Tags</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">December 7, 2016</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>981 words</span>
                            <span><i class="fas fa-clock mr-2"></i>5 mins read</span>
                        </div>

                        <h1>Million event Erlang “like” engine</h1>

                        <ul class="authors list-inline"><li class="list-inline-item mr-3">
                    <div class="media author"><a href="/authors/krishna-kumar-thokala/" class="mr-3">
                                    <picture>
                                        <source srcset="/authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_64x0_resize_box_2.png 1x, /authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_128x0_resize_q100_box_2.png 2x, /authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_192x0_resize_q100_box_2.png 3x">
                                        <img src="/authors/krishna-kumar-thokala/krishnakumart_hu508b74bb11feca0be536ac3c830fb287_817534_64x0_resize_box_2.png" class="rounded-circle" alt="Krishna Kumar Thokala">
                                    </picture>
                                </a><div class="media-body">
                            <h5 class="name my-0"><a href="/authors/krishna-kumar-thokala/" class="small">Krishna Kumar Thokala</a>
                            </h5><p class="social small text-muted">
                                    <a href="https://twitter.com/@krishnakumart36">@KrishnaKumarT36</a>
                                </p></div>
                    </div>
                </li></ul>
                    </div>
                </div><div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            

<h4 id="inspiration">Inspiration:</h4>

<p>Facebook has a very unique and custom architecture to handle millions of likes on its posts every second. Sometimes a post is so catchy that it will attract millions of likes per second and being a fan of that article you don’t want to miss its live statistics.</p>

<h4 id="shorten-the-goal">Shorten the goal:</h4>

<p>My goal is to create a like engine with can handle millions of likes per second. Let it be 1 like for 1 article/URL or 1000 likes for 1000 articles/URLs or 1 article/URL with million likes.</p>

<h2 id="the-architecture">The architecture:</h2>

<p>I have taken a very naive approach to solve this problem. I have created a event_manager with gen_event behavior to handle the events related to likes.</p>

<figure class="figure">
    <a href="/images/million-event-erlang-like-engine-flow.png" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
        <img src="/images/million-event-erlang-like-engine-flow.png"class="figure-img img-fluid"
        /> 
    </a>
</figure>


<blockquote>
<p><strong><em>Why gen_event?</em></strong>
I assume that I have webserver which listens for the events/requests from the client applications. This webserver is basically used to catch all the events without missing even one. The webserver will call an event to the event_manager process. Event handlers can be added to the event_manager process to handle events related to likes,unlikes,impressions etc. I mean, an event handler for like and unlikes, one for impressions and so on.</p>
</blockquote>

<p>Whenever an event_manager is started, following are performed:
1. Creates an ets table with ordered_set option and the control to edit it is given to the event_manager.
2. Adds an event handler to handle particular events.
3. Starts a batcher process which takes care of batching at regular intervals
4. Starts a worker_pool_man process which acts as an interface for worker_pool_sup process which is gen_supervisor behavior.</p>

<h3 id="worker-pool-manager">Worker pool manager:</h3>

<p>This is a gen_server process.</p>

<p>This basically starts the worker pool supervisor with a default number of workers(100+10(10% extra buffer processes)) and stores the list of these worker process ids in the state variable.</p>

<p>It contains functions to get a new worker process and also to kill some worker process when it is hung up/unresponsive.</p>

<h3 id="worker-pool-supervisor">Worker pool supervisor:</h3>

<p>This is a gen_supervisor behavior process with simple_one_for_one. Good thing about it is you can start just the supervisor process without any workers or child processes initially and you can add them or remove them on fly.</p>

<h3 id="worker-process">Worker process:</h3>

<p>It is a gen_server process which holds a state of the article/URL. The state contains a counter of the current like count. Since the counter is maintained in memory, many thousands of increments or decrements can be performed concurrently.</p>

<p>Each worker process is initially registered, which means the counter value will be set to 0. a commit request to the worker process will retrieve the current counter value.</p>

<h3 id="batcher-process">Batcher process:</h3>

<p>This is a gen_server process constantly listens to the event_manager to check whether the ETS table has reached its predefined limit. Whenever ETS table linked to the event<em>manager process reaches 2000 unique URL count, it signals the batcher process to take control of it. Batcher reads all the ETS entries and writes them to a file(tab</em><ETS table ID>). During this activity the event manager is given a new ETS table to be filled and event_manager is never blocked.</p>

<h3 id="how-the-whole-thing-works">How the whole thing works?</h3>

<p>Events coming into the web server are delivered to the event manager which in turn handled by the corresponding event handler. Every event is scrutinised and URL is extracted and stored in the ETS table if it doesn’t already exists. Here ETS table is created with ordered_set strategy but not a bag to store only unique entries. For every new entry into the ETS table a worker process is allocated by calling a worker pool manager. Worker pool manager allocates a worker process from its own list of buffer workers. However these worker processes are obtained from worker pool supervisor process. This is all about a new URL like event coming in.</p>

<p>What If we got a like from the same URL? Now it checks for its existence in the ETS table and get its worker process PID. As each and every worker process is a gen_server process. We basically give a cast call to it update the in memory counter for that particular URL.</p>

<p>That’s it, let us say, we have 1000 unique URL’s with 1000 likes coming in. You will have 1000 processes with counter value of 1000 for each one of them.</p>

<p>Or, we say, 1 million “like” events for a single URL also works by creating a single worker process with counter value of 1000000.</p>

<p>What happens next??</p>

<p>When the ETS table entry size reaches a certain predefined size. The table is given away to the BATCHER process which starts iterating over all the table entries and collects the like count and writes it to a file and then throws the table away. In this meantime, the event is not alone without the ETS table, it will create a new table and starts filling it up for the batcher process to be taken care of. While the batching is being done, the event manager is never blocked instead writes into a new table and new worker processes.</p>

<figure class="figure">
    <a href="/images/million-event-erlang-like-engine-design.png" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
        <img src="/images/million-event-erlang-like-engine-design.png"
             alt="Events -&amp;gt; ETS table -&amp;gt; worker processes -&amp;gt; batcher -&amp;gt; file"class="figure-img img-fluid"
        /> 
    </a><figcaption class="figure-caption text-center">
            <p>Events -&gt; ETS table -&gt; worker processes -&gt; batcher -&gt; file</p>
        </figcaption>
</figure>


<p>After batching an ETS table, the worker process ID’s are again donated to the event pool manager to be reused. If some process is too much used and hanging around for a while and sluggish, we simply kill it and spin up a new one to replace it. This is how we keep up the supply of worker processes for the demand.</p>

<h3 id="going-live-not-yet-implemented">Going Live(Not yet implemented):</h3>

<p>Another process can be employed to read these files in a sequential order of their creation time. Let us say we read 1000 URL’s and will be updating the database whose write tolerance may be limited. This process would have the privilege to control the read based on the write tolerance of the database to which these statistics have to be updated.</p>

<hr />

<h4 id="credits">Credits:</h4>

<p>Thanks to Konstantin Tcepliaev at 24[7] campanja, who has given me this challenge.</p>

<h4 id="references">References:</h4>

<p><a href="http://highscalability.com/blog/2011/3/22/facebooks-new-realtime-analytics-system-hbase-to-process-20.html">http://highscalability.com/blog/2011/3/22/facebooks-new-realtime-analytics-system-hbase-to-process-20.html</a></p>

                        </div><div class="tags my-3"><a class="badge badge-pill badge-light border mr-2" href="/tags/erlang">
                                    <i class="fas fa-tag mr-2"></i>erlang
                                </a></div><ul class="share nav my-3 justify-content-end">
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fmillion-event-erlang-engine%2f&text=Million%20event%20Erlang%20%e2%80%9clike%e2%80%9d%20engine">
              <i class="fa-fw fab fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fmillion-event-erlang-engine%2f&title=Million%20event%20Erlang%20%e2%80%9clike%e2%80%9d%20engine">
                <i class="fa-fw fab fa-linkedin-in"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fmillion-event-erlang-engine%2f&t=Million%20event%20Erlang%20%e2%80%9clike%e2%80%9d%20engine">
                <i class="fa-fw fab fa-facebook-f"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://reddit.com/submit?url=https%3a%2f%2fkrishnakumar4a4.github.io%2fpost%2fmillion-event-erlang-engine%2f&title=Million%20event%20Erlang%20%e2%80%9clike%e2%80%9d%20engine">
                <i class="fa-fw fab fa-reddit-alien"></i>
            </a>
        </li>
    </nav>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div></article>
        </div>
    </div>

    <div class="related-content row mt-5 row-cols-1 row-cols-lg-3"><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/github-projects/engines/" class="d-block"><div class="card-body">
            <h4 class="card-title">Code Challenges and Solutions</h4>
            <p class="card-text text-muted text-uppercase">November 26, 2016</p>
            <div class="card-text">
                1) anaMon: Million events Erlang like engine 2) crawler: A web crawler of infinte link traversal 3) histogram-table: Dynamic histogram generation from a csv file and bucketsize, on click gives values as table 4) poker-ex: A CLI two player poker game written in elixir
            </div>
        </div>
    </a>
</div>

            </div><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/post/beauty-mystery-erlang-distribution/" class="d-block"><div class="card-body">
            <h4 class="card-title">Beauty and mystery of Erlang distribution</h4>
            <p class="card-text text-muted text-uppercase">August 14, 2016</p>
            <div class="card-text">
                I work on a network element simulator written in Erlang. For us, each network element is a bunch of Erlang processes work together to simulate a network element and we are simulating tens and hundreds of them on each Erlang node. We also run a distributed network of erlang nodes which all together renders some thousands of network elements running on one Linux machine.
Done with background!!
The problem: We are not able to start more than 250 Erlang nodes on one Linux machine provided we have enough resources to start more of them, and thus limiting our network element count beyond some value.
            </div>
        </div>
    </a>
</div>

            </div></div>
    <footer>
        <script src="https://giscus.app/client.js"
    data-repo="krishnakumar4a4/krishnakumar4a4.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMDA3OTMxMTU="
    data-category="Blog Comments"
    data-category-id="DIC_kwDOBgH7G84CUoxF"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light_high_contrast"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
  <br/>
  <div style="border: 2px solid black; 
  border-radius: 5px; padding: 2px 5px 0px 5px;
  width: fit-content; 
  margin-left: auto; margin-right: 0;">
    <p style="text-align: right">
    <span style="font-family: sans-serif;font-size: 14px;"> Alternatively, you can  </span>
    <button style="background:#055d20;
    font-size: 14px;display: inline-block;
    border-bottom-color: #013d14;
    font-family: sans-serif;
    font-weight: 400;
    color:white;
    border-radius: 5px" onclick="window.location.href = 'https://github.com/krishnakumar4a4/krishnakumar4a4.github.io/discussions/categories/blog-comments';">
    Comment directly on Github Discussion
    </button>
    <br/>
    <span style="font-family: sans-serif;font-size: 14px;"><span>#️⃣</span>
    <span style="color: #055d20">Million event Erlang “like” engine</span>
    </span>
    </p>
  </div>
    </footer>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://krishnakumar4a4.github.io/index.xml" rel="alternate" type="application/rss+xml" class="icons d-block">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a></li><li class="list-inline-item">
                        <a href="mailto:krishna.thokala2010@gmail.com" class="icons d-block">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li><li class="list-inline-item">
                            <a href="https://github.com/krishnakumar4a4" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://keybase.io/krishnakumart" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-keybase fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.linkedin.com/in/krishnakumarthokala/" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://fsmi.social/krishnakumart" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://krishnakumart.medium.com/" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-medium fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://reddit.com/u/krishnakumart" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-reddit fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://twitter.com/KrishnaKumarT36" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; Krishna Kumar T 2023
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    



<script>
    window.Prism = window.Prism || {};
    window.Prism.manual = true;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>


<script src="/js/iframeResizer.min.js"></script>
<script src="/js/iframeResizer.contentWindow.min.js"></script>




    
</body>
</html>
